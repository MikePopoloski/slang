name: docs
description: Build and deploy documentation (both C++/slang and Python/pyslang)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install dependencies
      run: |
        pip install jinja2 pygments docutils
        wget https://sourceforge.net/projects/doxygen/files/rel-1.13.2/doxygen-1.13.2.linux.bin.tar.gz
        tar -xvf doxygen-1.13.2.linux.bin.tar.gz
        cp doxygen-1.13.2/bin/doxygen /usr/local/bin
        git clone https://github.com/mosra/m.css
    # TODO: This m.css clone is a second clone of m.css. CMake clones it once already. Should see if we can tap into that for the pyslang docs build.
    - name: Build and install pyslang with Pip
      run: |
        python -m pip install --upgrade pip
        pip install .
    - name: Build Python/pyslang docs
      run: |
        ./m.css/documentation/python.py ./pyslang/docs/conf.py
        du -a ./build/docs/
    - name: Build C++/slang docs
      run: |
        cmake -B build -DSLANG_INCLUDE_DOCS=ON -DSLANG_INCLUDE_TESTS=OFF
        cmake --build build --target docs -j8
        tar -czvf slang.tar.gz build/docs build/bin/slang
    - name: Upload
      if: github.event_name != 'pull_request'
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_DEPLOY_HOST }}
        username: ${{ secrets.SSH_DEPLOY_USERNAME }}
        port: ${{ secrets.SSH_DEPLOY_PORT }}
        key: ${{ secrets.SSH_DEPLOY_KEY }}
        passphrase: ${{ secrets.SSH_DEPLOY_PASSPHRASE }}
        source: slang.tar.gz
        target: upload/
    - name: Deploy
      if: github.event_name != 'pull_request'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_DEPLOY_HOST }}
        username: ${{ secrets.SSH_DEPLOY_USERNAME }}
        port: ${{ secrets.SSH_DEPLOY_PORT }}
        key: ${{ secrets.SSH_DEPLOY_KEY }}
        passphrase: ${{ secrets.SSH_DEPLOY_PASSPHRASE }}
        script: slang-website/deploy_docs.sh
